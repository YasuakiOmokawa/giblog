#!perl

use strict;
use warnings;

use Giblog;
use Getopt::Long 'GetOptions';
use List::Util 'first';
use Carp 'confess';

# Reorder command line args -x --xxx is after command
my @ordered_argv;
for my $arg (@ARGV) {
  if ($arg !~ /^-/) {
    push @ordered_argv, $arg;
  }
}
for my $arg (@ARGV) {
  if ($arg =~ /^-/) {
    push @ordered_argv, $arg;
  }
}
@ARGV = @ordered_argv;

# Command
my $command = shift @ARGV;
unless (defined $command) {
  die "Command must be specifed\n";
}
if ($command =~ /^-/) {
  die "Command \"$command\" is not found\n";
}

GetOptions(
  "giblog-dir=s" => \my $giblog_dir
);

my $giblog = Giblog->new(
  'giblog-dir' => $giblog_dir
);

# Command is implemented in plugin
my $plugin_class = "Giblog::Plugin::$command";
eval "use $plugin_class;";
if ($@) {
  confess "Can't find plugin $plugin_class";
}
my $plugin = $plugin_class->new(giblog => $giblog);

$plugin->plugin(@ARGV);
