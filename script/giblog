#!perl

use strict;
use warnings;

use Giblog;
use Getopt::Long 'GetOptions';
use List::Util 'first';
use Carp 'confess';

# Reorder command line args -x --xxx is after command
my @ordered_argv;
for my $arg (@ARGV) {
  if ($arg !~ /^-/) {
    push @ordered_argv, $arg;
  }
}
for my $arg (@ARGV) {
  if ($arg =~ /^-/) {
    push @ordered_argv, $arg;
  }
}
@ARGV = @ordered_argv;

# Command
my $command = shift @ARGV;
unless (defined $command) {
  die "Command must be specifed\n";
}
if ($command =~ /^-/) {
  die "Command \"$command\" is not found\n";
}

GetOptions(
  "giblog-dir=s" => \my $giblog_dir
);

my $giblog = Giblog->new(
  'giblog-dir' => $giblog_dir
);

# Create new website
my $plugin = "Giblog::Plugin::$command";
if ($command eq 'new_website') {
  
  eval "use $plugin;";
  if ($@) {
    confess "Can't find plugin $plugin";
  }
  
  $plugin->plugin($giblog, @ARGV);
}
elsif ($command eq 'new_entry') {
  $giblog->new_entry;
}
elsif ($command eq 'build') {
  eval "use $plugin;";
  if ($@) {
    confess "Can't find plugin $plugin";
  }
  
  $plugin->plugin($giblog, @ARGV);
}
else {
  die "Command \"$command\" is not found\n";
}
